```plantuml
@startuml
title File Processing Pipeline - Sequence (SHA-256 + Markdown + Async SimHash)

' Participants
actor Dispatcher
participant "Cloud Run Job\n(step-1: source fingerprint)" as Step1
participant "Cloud Run Job\n(step-2: text extraction)" as Step2
participant "Cloud Run Job\n(step-3: metadata export)" as Step3
participant "Cloud Run Job\n(simhash-worker: async)" as Simhash
database "PostgreSQL\n(file_control, file_fingerprints,\nsimhash_buckets)" as DB
collections "Object Storage\n(source files + markdown)" as Storage

' --- Step 1: SHA-256 fingerprint ---
Dispatcher -> Step1: Run job(file_id, tenant_id, source_uri, ...)
Step1 -> Storage: Read source file (stream)
Storage --> Step1: source bytes stream
Step1 -> Step1: Compute content_sha256 + size
Step1 -> DB: UPSERT file_fingerprints\nSET content_sha256, content_size_bytes,\nsource_* (by file_id)
DB --> Step1: OK
Step1 --> Dispatcher: Job success

' --- Step 2: Markdown extraction ---
Dispatcher -> Step2: Run job(file_id, tenant_id, source_uri, ...)
Step2 -> Storage: Read source file / extracted content
Storage --> Step2: content stream
Step2 -> Step2: Extract text -> Markdown (.md)
Step2 -> Storage: Write markdown to md_uri
Storage --> Step2: md_uri
Step2 -> Storage: (optional) Read md for hashing
Storage --> Step2: md bytes
Step2 -> Step2: Compute md_sha256 + md_size_bytes
Step2 -> DB: UPDATE file_fingerprints\nSET md_uri, md_sha256, md_size_bytes\nWHERE file_id
DB --> Step2: OK
Step2 --> Dispatcher: Job success

' --- Async trigger for SimHash worker ---
Dispatcher -> Simhash: Run job async(file_id, tenant_id)\n(fire-and-forget)
note right of Dispatcher
Simhash is not part of the critical path.
Step 3 must NOT wait for Simhash completion.
end note

' --- Step 3: Metadata export (does not wait) ---
Dispatcher -> Step3: Run job(file_id, tenant_id, ...)
Step3 -> DB: Read processing + fingerprint metadata\n(file_control + file_fingerprints)
DB --> Step3: metadata payload
Step3 -> Step3: Export metadata (target system)
Step3 --> Dispatcher: Job success

' --- Simhash worker execution (async) ---
Simhash -> DB: SELECT md_uri, md_sha256,\nsimhash_u64, simhash_version\nWHERE file_id FOR UPDATE
DB --> Simhash: row
alt md_uri IS NULL
  Simhash -> Simhash: Exit (markdown not ready)
else simhash already computed for current version
  Simhash -> Simhash: Exit (idempotent no-op)
else compute simhash
  Simhash -> Storage: Read markdown(md_uri)
  Storage --> Simhash: md bytes
  Simhash -> Simhash: Normalize + tokenize MD
  Simhash -> Simhash: Compute simhash_u64 (64-bit)
  Simhash -> Simhash: Split into 8x8 bands -> bucket_key[8]
  Simhash -> DB: BEGIN
  Simhash -> DB: DELETE simhash_buckets\nWHERE file_id
  Simhash -> DB: UPDATE file_fingerprints\nSET simhash_u64, simhash_version,\nsimhash_updated_at\nWHERE file_id
  Simhash -> DB: INSERT simhash_buckets\n(tenant_id, bucket_key, file_id, simhash_u64)\n(8 rows)
  Simhash -> DB: COMMIT
  DB --> Simhash: OK
end

@enduml
```
