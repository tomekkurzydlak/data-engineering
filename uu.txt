@startuml

actor Dispatcher

participant "Cloud Run Job\n(md-preprocess)" as Job
participant "GCS Source Bucket" as GCS_IN
participant "GCS Target Bucket" as GCS_OUT
database "PostgreSQL\n(Stored Procedures)" as PG

Dispatcher -> Job: start_job(INPUTS, ENV)

loop for each gs://file in INPUTS

    Job -> GCS_IN: read_object(gs://source/file.md)
    GCS_IN --> Job: markdown content

    Job -> Job: analyze_markdown()\ncompute word_count

    Job -> PG: add_file_f(gcs_uri, NULL, tech_insert_id)

    Job -> PG: update_file_meta_f(file_id,\njsonb_meta, tech_update_id)

    Job -> GCS_OUT: write_object(gs://target/file.md)

    Job -> PG: update_file_status_f(\nfile_id, process_id,\n"COMPLETED", NULL,\ntech_update_id)

end

alt any error occurred
    Job -> PG: update_file_status_f(\nfile_id, process_id,\n"ERROR", err_msg,\ntech_update_id)
    Job -> Dispatcher: exit code != 0\nRED
else all OK
    Job -> Dispatcher: exit code == 0\nGREEN
end

@enduml


===


. Cel us≈Çugi
MD Preprocess to proces batch uruchamiany w Google Cloud Run przez Dispatcher, kt√≥rego zadaniem jest:
pobranie pliku Markdown z GCS (gs://...),
analiza zawarto≈õci (np. word_count),
zapis metadanych do bazy przez procedury sk≈Çadowane,
zapis przetworzonego artefaktu do docelowego bucketu GCS,
raportowanie statusu COMPLETED / ERROR zar√≥wno do bazy jak i do Dispatchera (przez exit code).
2. Wej≈õcie do procesu
Proces uruchamiany jest przez Dispatcher jako Cloud Run Job.
Parametry ≈õrodowiskowe:
ENV	Opis
INPUTS	Lista URI plik√≥w wej≈õciowych gs://..., oddzielona ,
TGT_PATH	Docelowa lokalizacja GCS gs://bucket/path
PROCESS_ID	ID procesu z Dispatchera
FILE_ID	ID pliku w orchestratorze
TECH_INSERT_ID	ID techniczne do add_file_f
TECH_UPDATE_ID	ID techniczne do update‚Äô√≥w
DBHOST	≈öcie≈ºka unix socket do Cloud SQL (/cloudsql/...)
DBPORT	Port (zwykle 5432)
DBUSER	U≈ºytkownik DB
DBPASS	Has≈Ço DB
DBNAME	Nazwa bazy
3. Og√≥lny workflow
Dla ka≈ºdego URI z INPUTS:
Download pliku z GCS (read_object)
Analiza MD
obliczanie word_count
Wywo≈Çanie DB
add_file_f(...)
Zapis metadanych
update_file_meta_f(file_id, jsonb_meta, tech_update_id)
Upload wyniku do GCS
zapis pod TGT_PATH/<oryginalna_nazwa_pliku>.md
Update statusu w DB
update_file_status_f(...)
4. Obs≈Çuga b≈Çƒôd√≥w
Ka≈ºdy krok w process_file():
zwraca Result<()>
u≈ºywa operatora ?
Mechanizm:
match process_file(...) {
    Ok(_) => report_status_safe("COMPLETED"),
    Err(err) => report_status_safe("ERROR", Some(err_chain)),
}
Flaga had_error:
je≈ºeli jakikolwiek plik zako≈Ñczy siƒô b≈Çƒôdem:
main() -> return Err(...)
Cloud Run job ko≈Ñczy siƒô kodem ‚â† 0 (RED)
je≈ºeli wszystkie pliki OK:
main() -> Ok(())
job ko≈Ñczy siƒô sukcesem (GREEN)
5. Kontrakt status√≥w
Stan procesu	Status DB	Exit code	Status w Dispatcher
‚úÖ Wszystkie OK	COMPLETED	0	üü¢ ZIELONY
‚ùå B≈ÇƒÖd dowolnego pliku	ERROR	!= 0	üî¥ CZERWONY
6. JSON metadanych
Przyk≈Çadowy payload przekazywany do update_file_meta_f:
{
    "word_count": 1023
}
Przekazywany bezpo≈õrednio jako jsonb przez:
&Json(&meta_json)
7. Schemat UML ‚Äì pe≈Çny przep≈Çyw
Gotowy diagram w PlantUML:
@startuml

actor Dispatcher

participant "Cloud Run Job\n(md-preprocess)" as Job
participant "GCS Source Bucket" as GCS_IN
participant "GCS Target Bucket" as GCS_OUT
database "PostgreSQL\n(Stored Procedures)" as PG

Dispatcher -> Job: start_job(INPUTS, ENV)

loop for each gs://file in INPUTS

    Job -> GCS_IN: read_object(gs://source/file.md)
    GCS_IN --> Job: markdown content

    Job -> Job: analyze_markdown()\ncompute word_count

    Job -> PG: add_file_f(gcs_uri, NULL, tech_insert_id)

    Job -> PG: update_file_meta_f(file_id,\njsonb_meta, tech_update_id)

    Job -> GCS_OUT: write_object(gs://target/file.md)

    Job -> PG: update_file_status_f(\nfile_id, process_id,\n"COMPLETED", NULL,\ntech_update_id)

end

alt any error occurred
    Job -> PG: update_file_status_f(\nfile_id, process_id,\n"ERROR", err_msg,\ntech_update_id)
    Job -> Dispatcher: exit code != 0\nRED
else all OK
    Job -> Dispatcher: exit code == 0\nGREEN
end

@enduml
8. Komponenty systemowe
GCS
≈πr√≥d≈Ço ‚Äì wej≈õciowe pliki MD
Cel ‚Äì /TGT_PATH/<original_filename>.md
PostgreSQL
Us≈Çuga korzysta wy≈ÇƒÖcznie z procedur:
Procedura	Rola
add_file_f()	Rejestracja pliku w systemie
update_file_meta_f()	Zapis JSON metadanych
update_file_status_f()	Raportowanie statusu
Cloud Run
Ka≈ºde wywo≈Çanie = osobny Job
Single thread / jeden batch
Status joba sterowany przez exit code aplikacji
9. Kluczowe cechy architektury
‚úÖ Brak bezpo≈õrednich INSERT/UPDATE ‚Äì tylko procedury
‚úÖ Pe≈Çna izolacja proces√≥w
‚úÖ Sp√≥jne DB ‚Üî Storage
‚úÖ Zero "half-success" (brak stanu: DB ERROR + GCS OUTPUT)
‚úÖ Job ko≈Ñczy siƒô RED przy dowolnym b≈Çƒôdzie
10. Security
Auth GCS przez ADC Cloud Run SA
PostgreSQL po Unix Socket (/cloudsql/...)
Brak przekazywania hase≈Ç w URI
