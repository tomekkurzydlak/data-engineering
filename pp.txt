@startuml
title UDR Dispatcher – Dynamic/Static Workflow Sequence

actor User
participant Dispatcher
participant DB
participant Queue as CrossbeamQueue
participant WorkerThread
participant CloudRun as CloudRunBackend

User -> Dispatcher: run(files[], workflow_type, dispatch_mode)

== STATIC + BATCH ==
Dispatcher -> Dispatcher: collect_sorted_seqs()
loop for each seq
    Dispatcher -> Dispatcher: run_batch_for_steps(seq)
    alt grouping=per-image
        Dispatcher -> CloudRun: start_job(batch_payload)
        CloudRun --> Dispatcher: exec_id
        Dispatcher -> CloudRun: poll_until_done(exec_id)
    else grouping=per-file
        loop for each file/step
            Dispatcher -> CloudRun: start_job(step)
            CloudRun --> Dispatcher: exec_id
            Dispatcher -> CloudRun: poll_until_done(exec_id)
        end
    end
end

== STATIC + ASYNC ==
Dispatcher -> CrossbeamQueue: enqueue all (file,seq)
Dispatcher -> WorkerThread: spawn max_workers threads

loop worker loop
    WorkerThread -> CrossbeamQueue: recv(task)
    WorkerThread -> CloudRun: start_job(task)
    CloudRun --> WorkerThread: exec_id
    WorkerThread -> CloudRun: poll_until_done(exec_id)
end

== DYNAMIC + BATCH ==
Dispatcher -> Dispatcher: extract first steps from payload
Dispatcher -> Dispatcher: run_batch_for_steps(first_steps)
loop for each file
    Dispatcher -> DB: get_steps_for_file(file_id)
    DB --> Dispatcher: [seq2, seq3, ...]
end
loop while steps remain
    Dispatcher -> Dispatcher: collect next seq from queues
    Dispatcher -> Dispatcher: run_batch_for_steps(next_seq)
end

== DYNAMIC + ASYNC ==
Dispatcher -> CrossbeamQueue: enqueue first step for each file
Dispatcher -> WorkerThread: spawn max_workers

loop worker loop
    WorkerThread -> CrossbeamQueue: recv(task)
    WorkerThread -> CloudRun: start_job(task)
    CloudRun --> WorkerThread: exec_id
    WorkerThread -> CloudRun: poll_until_done(exec_id)

    alt steps not yet loaded
        WorkerThread -> DB: get_steps_for_file(file_id)
        DB --> WorkerThread: full step list (seq2..N)
        WorkerThread -> CrossbeamQueue: enqueue(next_step)
    else steps in cache
        WorkerThread -> CrossbeamQueue: enqueue(next_step)
    end

    alt no more steps
        WorkerThread -> Dispatcher: decrement remaining_files
    end
end

Dispatcher -> DB: end_session()
@enduml

sequence
component
@startuml
title UDR Dispatcher – Component Architecture

package "UDR Dispatcher" {
  [Dispatcher] --> [ProcessorBackend]
  [Dispatcher] --> [DB Layer]
  [Dispatcher] --> [CrossbeamQueue]
  [Dispatcher] --> [WorkerPool]
}

package "Runtime" {
  [WorkerPool] --> [CloudRunBackend]
  [WorkerPool] --> [CrossbeamQueue]
  [WorkerPool] --> [DB Layer]
}

package "GCP" {
  [CloudRunBackend] --> [Cloud Run Jobs]
  [CloudRunBackend] --> [Cloud Run Executions]
}

package "Database" {
  [DB Layer] --> [PostgreSQL]
}

@enduml
