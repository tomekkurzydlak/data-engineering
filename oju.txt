info!(
    count = first_steps.len(),
    "DYNAMIC+BATCH: start — batch pierwszych kroków (payload)"
);

// process_cd bierzemy z pierwszego kroku
let first_process_cd = first_steps[0].2.process_cd.clone();

if let Some(db) = &self.db {
    let file_watcher_id = self.cfg.file_watcher_id.unwrap_or(0);
    let tech_insert_id = self.cfg.tech_insert_id.unwrap_or(0);

    let pid = db
        .init_batch_session(&first_process_cd, file_watcher_id, tech_insert_id)
        .await
        .context("DYNAMIC+BATCH: błąd start_process_watcher_f dla pierwszego batcha (payload)")?;

    let result = self.run_batch_for_steps(&first_steps).await;

    let tech_update_id = self.cfg.tech_insert_id.unwrap_or(0);

    let (status_cd, error_msg) = match &result {
        Ok(_) => ("COMPLETED", "".to_string()),
        Err(e) => ("ERROR", e.to_string()),
    };

    if let Err(e) = db
        .end_session(pid, status_cd, &error_msg, tech_update_id)
        .await
    {
        error!(
            error=?e,
            %pid,
            %file_watcher_id,
            "DYNAMIC+BATCH: błąd finish_process_f dla pierwszego batcha (payload)"
        );
    }

    result?;
} else {
    self.run_batch_for_steps(&first_steps).await?;
}
