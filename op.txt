6. Obsługa błędów
6.1. Źródła błędów
Dispatcher może otrzymać błędy z:
API Cloud Run (start error)
czasu oczekiwania poll_timeout
niepoprawnych danych zwróconych przez procedury DB
błędów JSON/parsing
paniców w programach workerowych Cloud Run
6.2. Rejestracja błędów
Każdy błąd powoduje:
zakończenie aktywnej sesji kroku:
finish_process_f("ERROR", "<opis błędu>")
oznaczenie error_flag → run kończy się komunikatem ostrzegawczym
Dispatcher nie przerywa globalnie innych kroków — błąd jest izolowany per plik / per batch.
7. Monitoring Cloud Run
Dispatcher monitoruje wykonanie jobów Cloud Run przez metodę:
poll_until_done(exec_id, poll_timeout, poll_interval)
Polling bazuje wyłącznie na API Cloud Run Jobs – Dispatcher nie analizuje logów Cloud Logging.
7.1. Stacktrace / paniki
Dispatcher nie odbiera stacktrace bezpośrednio z Cloud Logging.
Aby raportować panic:
✅ worker musi wypisać JSON error payload
✅ Dispatcher odczytuje parametr failureMessage z API joba
✅ zapisuje komunikat do finish_process_f.
8. Kolejki i współbieżność
8.1. Async workflow
Implementacja kolejki: crossbeam_channel
N elementów w kolejce = max liczba jednocześnie aktywnych tasków
Worker pool oparty o std::thread + tokio runtime
8.2. Gwarancje
✅ kolejne kroki pliku wykonywane zawsze sekwencyjnie
✅ różne pliki przetwarzane równolegle
✅ nie ma deadlocków:
kolejka zamykana poprawnie
workers gaszą się po remaining_files == 0
